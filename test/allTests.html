<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../jslib/jquery.jsPlumb-1.5.4-min.js"></script>

	<script type="text/javascript" src="../js/jilParser.js"></script>
    <script type="text/javascript" src="../js/JilConnection.js"></script>
    <script type="text/javascript" src="../js/GraphBuilder.js"></script>
    <link rel="stylesheet" href="../css/jilGraph.css">

    <!-- QUnit -->
    <link rel="stylesheet" href="../jslib/qunit-1.12.0.css">
    <script src="../jslib/qunit-1.12.0.js"></script>
    <!-- QUnit -->


    <script type="text/javascript">
        "use strict";
        
        $(document).ready(function() {
            var jilParser = new JilParser();
            
            var testJil =
            [
              {
                "name": "job0_1",
                "job_type": "c",
                "command": 'start ""',
                "condition": [],
              },
              {
                "name": "box1",
                "job_type": "b",
                "condition": [],
              },
              {
                "name": "job1_1",
                "job_type": "c",
                "command": 'start ""',
                "box_name": "box1",
                "condition" : [ new JilConnection("job1_1", "job0_1", "s") ],
              },
              {
                "name": "job1_2",
                "job_type": "c",
                "command": 'start ""',
                "box_name": "box1",
                "condition": [],
              },
              
              {
                "name": "box2",
                "job_type": "b",
                "condition": [],
              },
              {
                "name": "job2_1",
                "job_type": "c",
                "box_name": "box2",
                "condition" : [ 
                    new JilConnection("job2_1", "job0_1", "s"),
                    new JilConnection("job2_1", "job1_2", "s"),
                    new JilConnection("job2_1", "box1", "s")
                ],
              },
            ];

            QUnit.test( "JilParser.removeComments", function( assert ) {
                assert.equal( jilParser.removeComments($("#testJil1").text()), 
                    $("#removeCommentsResult").text().trim());
            });        

            QUnit.test("JilParser.findJob", function( assert ) {
                var inputJilArray =
                [
                  {
                    "name": "box1",
                    "job_type": "b",
                  },
                  {
                    "name": "job1",
                    "job_type": "c",
                  },
                ];
                assert.equal(jilParser.findJob(inputJilArray, "box1"), inputJilArray[0]);
                assert.equal(jilParser.findJob(inputJilArray, "job1"), inputJilArray[1]);
            });
            
            QUnit.test("JilParser.parseCondition", function( assert ) {
                assert.deepEqual(jilParser.parseCondition("test: s(job1) and n(job2)|(success(box1)& s(box2)) or  failure  (job3) and (s(job4))"), [
                    { dependencyName: "job1", status: "s" },
                    { dependencyName: "job2", status: "n" },
                    { dependencyName: "box1", status: "s" },
                    { dependencyName: "box2", status: "s" },
                    { dependencyName: "job3", status: "f" },
                    { dependencyName: "job4", status: "s" },
                ]);
            });

            QUnit.test("JilParser.getDependencies", function( assert ) {
                var job1 = {
                    "name": "job1",
                    "job_type": "c",
                };
                var job2 = {
                    "name": "job2",
                    "job_type": "c",
                };
                var job3 = {
                    "name": "job3",
                    "job_type": "c",
                    "condition": "s(job1) & f(job4) & n(unknownJob)",
                };
                var job4 = {
                    "name": "job4",
                    "job_type": "c",
                };
                var unknownJob = {
                    "name": "unknownJob",
                    "job_type": "c",
                    "box_name": "External_Jobs",
                    "condition": [],
                };

                var sourceJilArray = [ job1, job2, job3, job4 ];
                var expectedJilArrayAfterParse = [ job1, job2, job3, job4 ];
                var externalJobs = [];
                assert.deepEqual(jilParser.getDependencies(sourceJilArray, job1, externalJobs), []);
                assert.deepEqual(externalJobs, []);
                assert.deepEqual(sourceJilArray, expectedJilArrayAfterParse);

                externalJobs = [];
                assert.deepEqual(jilParser.getDependencies(sourceJilArray, job3, externalJobs)[0], [
                    new JilConnection("job3", "job1", "s"),
                    new JilConnection("job3", "job4", "f"),
                    new JilConnection("job3", "unknownJob", "f"),
                ][0]);
                assert.deepEqual(externalJobs, [unknownJob]);
                assert.deepEqual(sourceJilArray, expectedJilArrayAfterParse.concat([
                    {
                        "name": "unknownJob",
                        "job_type": "c",
                        "box_name": "External_Jobs",
                        "condition": [],
                    },
                ]));
            });

            QUnit.test( "JilParser.parse", function( assert ) {
                var job1_1 = { "box_name": "box1", "command": "start \"\"", "condition": [], "job_type": "c", "name": "job1_1" };
                var job1_2 = { "name": "job1_2", "job_type": "c", "box_name": "box1",
                    "condition": [
                        new JilConnection("job1_2",  "job1_1", "s"),
                        new JilConnection("job1_2",  "externalJob", "s")
                    ],
                };
                var expected = [
                    { "name": "External_Jobs", "job_type": "b", "condition": [] },
                    { "name": "box1", "job_type": "b", "condition": [] },
                    { "name": "job1_1", "job_type": "c", "box_name": "box1", "command": "start \"\"", "condition": [] },
                    { "name": "job1_2", "job_type": "c", "box_name": "box1", 
                        "condition": [
                            new JilConnection("job1_2",  "job1_1", "s"),
                            new JilConnection("job1_2",  "externalJob", "s"),
                        ]
                    },
                    { "name": "externalJob", "job_type": "c", "box_name": "External_Jobs", "condition": [] },
                ];
                assert.deepEqual( jilParser.parse($("#testJil1").text()), expected);
            });
            
            QUnit.test("jilParser.validate - circular dependencies", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                var jilArray = [
                    { name: "job0", job_type: "c", condition: [] },
                    { name: "job1", job_type: "c", condition: [ new JilConnection("job1", "job3", "s") ] },
                    { name: "job2", job_type: "c", condition: [ new JilConnection("job2", "job1", "s") ] },
                    { name: "job3", job_type: "c", condition: [ new JilConnection("job3", "job2", "s") ] },
                ];
                assert.throws(function() {
                    jilParser.validate(jilArray);
                }, Error);
                
                // Job dependent on itself
                var jilArray2 = [
                    { name: "job0", job_type: "c", condition: [] },
                    { name: "job1", job_type: "c", condition: [ new JilConnection("job1", "job1", "s") ] },
                ];
                assert.throws(function() {
                    jilParser.validate(jilArray);
                }, Error);
            });

            var addJobTest = function( assert, jobType, divClass ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                var job = {name: "job1", job_type: jobType};

                var div = builder.addJobDiv(job, builder.topContainer);
                
                assert.equal(div.id, builder.idPrefix + job.name);
                assert.equal(div.className, divClass);
                assert.equal(div.innerText, job.name);
                assert.equal(div.parentElement.id, "graphContainer1");
            };
            
            var initBuilder = function(jilObject, topContainer) {
                if (topContainer != undefined) {
                    $(topContainer).empty();
                }
                return new GraphBuilder(jilObject, topContainer);
            }
            
            QUnit.test("GraphBuilder.addJobDiv - job", function( assert ) {
                addJobTest(assert, "c", "endpoint job");
            });

            QUnit.test("GraphBuilder.addJobDiv - box", function( assert ) {
                addJobTest(assert, "b", "endpoint box");
            });

            QUnit.test("getBoxChildren - not a box", function( assert ) {
                var builder = initBuilder(testJil);
                var jobArray = $.grep(testJil, function(job) { return job.name == "job1_1"; });
                assert.equal(jobArray.length, 1);
                assert.equal(builder.getBoxChildren(jobArray[0]).length, 0); 
            });
            
            QUnit.test("getBoxChildren", function( assert ) {
                var builder = initBuilder(testJil);
                var jobArray = $.grep(testJil, function(job) { return job.name == "box1"; });
                var children = builder.getBoxChildren(jobArray[0]);
                assert.equal(children.length, 2);
                $.each(children, function(i, child) { 
                    assert.equal(child.name, "job1_" + (i+1));
                });
            });
            
            QUnit.test("getTopLevelJobs", function( assert ) {
                var builder = initBuilder(testJil);
                var jobs = builder.getTopLevelJobs();
                assert.equal(jobs.length, 3);
                assert.equal(jobs[0].name, "job0_1");
                assert.equal(jobs[1].name, "box1");
                assert.equal(jobs[2].name, "box2");
            });
            
            QUnit.test("addJobWithChildren", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                var jobArray = $.grep(testJil, function(job) { return job.name == "box1"; });
                builder.addJobWithChildren(jobArray[0], builder.topContainer);
                assert.equal($(builder.topContainer).children().length, 1);
                var boxDiv = $(builder.topContainer).children()[0];
                assert.equal($(boxDiv).children().length, 2);
            });

            QUnit.test("insertDivs", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                builder.insertDivs();
                assert.equal($(builder.topContainer).children().length, 3);
            });
            
            QUnit.test("getConnections", function( assert ) {
                var job1 = { name: "job1", job_type: "c", condition: [] };
                var job2 = { name: "job2", job_type: "c", condition: [ new JilConnection("job2", "job1", "s") ] };
                var job3 = { name: "job3", job_type: "c", condition: [ new JilConnection("job3", "job1", "s") ] };
                var job4 = { name: "job4", job_type: "c", condition: [ 
                    new JilConnection("job4", "job1", "s"),
                    new JilConnection("job4", "job2", "n"),
                    new JilConnection("job4", "box1", "s"),
                    new JilConnection("job4", "box2", "s"),
                    new JilConnection("job4", "job3", "f"),
                ]};
                var box1 = { name: "box1", job_type: "b", condition: [] };
                var box2 = { name: "box2", job_type: "b", condition: [] };
                var jil = [job1, job2, job3, job4, box1, box2];

                var builder = initBuilder(jil, $("#graphContainer1")[0]);
                var actualConnections = builder.getConnections();
                var expectedConnections = [
                    new JilConnection("job2", "job1", "s"),
                    new JilConnection("job3", "job1", "s"),
                    new JilConnection("job4", "job1", "s"),
                    new JilConnection("job4", "job2", "n"),
                    new JilConnection("job4", "box1", "s"),
                    new JilConnection("job4", "box2", "s"),
                    new JilConnection("job4", "job3", "f"),
                ];
                $.each(actualConnections, function(i, actualConnection) {
                    assert.deepEqual(actualConnection, expectedConnections[i], "Connection number " + i);
                });
            });

            QUnit.test("getInbound&OutboundConnections", function( assert ) {
                var job0 = { name: "job0", job_type: "c", condition: [] };
                var job1 = { name: "job1", job_type: "c", condition: [ new JilConnection("job1", "job0", "s") ] };
                var job2 = { name: "job2", job_type: "c", condition: [ new JilConnection("job2", "job1", "s"), new JilConnection("job2", "job0", "s") ] };
                var job3 = { name: "job3", job_type: "c", condition: [ new JilConnection("job3", "job2", "s") ] };
                var jilArray = [ job0, job1, job2, job3 ];
                var builder = initBuilder(jilArray, $("#graphContainer1")[0]);
                assert.deepEqual(builder.getOutboundConnections(job0, true), [], "out job0, true");
                assert.deepEqual(builder.getOutboundConnections(job0, false), [], "out job0, false");
                assert.deepEqual(builder.getInboundConnections(job0, true), [ 
                    new JilConnection("job1", "job0", "s"), 
                    new JilConnection("job2", "job0", "s") 
                ], "int job0, true");
                assert.deepEqual(builder.getInboundConnections(job0, false), [ 
                    new JilConnection("job1", "job0", "s"), 
                    new JilConnection("job2", "job0", "s"),
                    new JilConnection("job2", "job1", "s"),
                    new JilConnection("job3", "job2", "s") 
                ], "int job0, false");
                assert.deepEqual(builder.getOutboundConnections(job2, true), [ 
                    new JilConnection("job2", "job1", "s"),
                    new JilConnection("job2", "job0", "s") 
                ], "out job2, true");
                // job2 -> job1 should not repeat
                assert.deepEqual(builder.getOutboundConnections(job2, false), [ 
                    new JilConnection("job2", "job1", "s"),
                    new JilConnection("job2", "job0", "s"),
                    new JilConnection("job1", "job0", "s") 
                ], "out job2, false");
                assert.deepEqual(builder.getOutboundConnections(job3, false), [ 
                    new JilConnection("job3", "job2", "s"),
                    new JilConnection("job2", "job1", "s"),
                    new JilConnection("job2", "job0", "s"),
                    new JilConnection("job1", "job0", "s") 
                ], "out job3, false");
            });

            QUnit.test("draw", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                console.log("draw");
                builder.draw();
                expect(0);
            });
        });
    </script>

    <style type="text/css">
        code { white-space: pre; }
    </style>

</head>

<body>

    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    
    <code id="graphContainer1"></code>
    <hr/>
    <code id="testJil1">
delete_job: AAA
delete_machine: BBB
    
/* 
* Box1s 1
*/

insert_job: box1
job_type: b

/* Job 1_1 */

insert_job: job1_1 /* Another comment */
job_type: c
box_name: box1
command: start "/* 'some'thing */"

insert_job: job1_2
job_type: c
box_name: box1
condition: s(job1_1) and s(externalJob)
    </code>
    <hr/>
    <code id="removeCommentsResult">
delete_job: AAA
delete_machine: BBB
    


insert_job: box1
job_type: b



insert_job: job1_1 
job_type: c
box_name: box1
command: start ""

insert_job: job1_2
job_type: c
box_name: box1
condition: s(job1_1) and s(externalJob)
    </code>
    <hr/>
    <code id="quoteValuesResult">
{
"box1": {
"job_type": "b",
},
"job1_2": {
"job_type": "c",
"command": "start \"\"",
}}
    </code>
    <hr/>
    <code id="test1">
{
"box1": {
"job_type": "b",
},
"job1_2": {
"job_type": "c",
"command": "start \"\"",
}}
    </code>
	
</body>
</html> 
