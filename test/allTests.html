<!DOCTYPE html>
<html>

<head>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.0/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../jslib/jquery.jsPlumb-1.5.4-min.js"></script>

	<script type="text/javascript" src="../js/jilParser.js"></script>
    <script type="text/javascript" src="../js/JilConnection.js"></script>
    <script type="text/javascript" src="../js/GraphBuilder.js"></script>

    <!-- QUnit -->
    <link rel="stylesheet" href="../jslib/qunit-1.12.0.css">
    <script src="../jslib/qunit-1.12.0.js"></script>
    <!-- QUnit -->

    <link rel="stylesheet" href="../css/jilGraph.css">

    <script type="text/javascript">
        "use strict";
        
        $(document).ready(function() {
            var jilParser = new JilParser();
            
            var testJil =
            [
              {
                "name": "job0_1",
                "job_type": "c",
                "command": 'start ""',
              },

              {
                "name": "box1",
                "job_type": "b",
              },
              {
                "name": "job1_1",
                "job_type": "c",
                "command": 'start ""',
                "box": "box1"
              },
              {
                "name": "job1_2",
                "job_type": "c",
                "command": 'start ""',
                "box": "box1",
                test: { a1: "aa", b1: "bb"}
              },
              
              {
                "name": "box2",
                "job_type": "b",
              },
              {
                "name": "job2_1",
                "job_type": "c",
                "box": "box2"
              },
            ];

            QUnit.test( "removeComments", function( assert ) {
                assert.equal( jilParser.removeComments($("#testJil1").text()), 
                    $("#removeCommentsResult").text().trim());
            });        

            QUnit.test( "parse", function( assert ) {
                var expected =
                [
                  {
                    "job_type": "b",
                    "name": "box1"
                  },
                  {
                    "command": 'start ""',
                    "job_type": "c",
                    "name": "job1_2"
                  }
                ];
                assert.deepEqual( jilParser.parse($("#testJil1").text()), 
                    expected);
            });
            
            var addJobTest = function( assert, jobType, divClass ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                var job = {name: "job1", job_type: jobType};

                var div = builder.addJobDiv(job, builder.topContainer);
                
                console.log(div);
                
                assert.equal(div.id, builder.idPrefix + job.name);
                assert.equal(div.className, divClass);
                assert.equal(div.innerText, job.name);
                assert.equal(div.parentElement.id, "graphContainer1");
            };
            
            var initBuilder = function(jilObject, topContainer) {
                if (topContainer != undefined) {
                    $(topContainer).empty();
                }
                return new GraphBuilder(jilObject, topContainer, jsPlumb);
            }
            
            QUnit.test("addJobDiv - job", function( assert ) {
                addJobTest(assert, "c", "job");
            });

            QUnit.test("addJobDiv - box", function( assert ) {
                addJobTest(assert, "b", "box");
            });

            QUnit.test("getBoxChildren - not a box", function( assert ) {
                var builder = initBuilder(testJil);
                var jobArray = $.grep(testJil, function(job) { return job.name == "job1_1"; });
                assert.equal(jobArray.length, 1);
                assert.equal(builder.getBoxChildren(jobArray[0]).length, 0); 
            });
            
            QUnit.test("getBoxChildren", function( assert ) {
                var builder = initBuilder(testJil);
                var jobArray = $.grep(testJil, function(job) { return job.name == "box1"; });
                var children = builder.getBoxChildren(jobArray[0]);
                assert.equal(children.length, 2);
                $.each(children, function(i, child) { 
                    assert.equal(child.name, "job1_" + (i+1));
                });
            });
            
            QUnit.test("getTopLevelJobs", function( assert ) {
                var builder = initBuilder(testJil);
                var jobs = builder.getTopLevelJobs();
                assert.equal(jobs.length, 3);
                assert.equal(jobs[0].name, "job0_1");
                assert.equal(jobs[1].name, "box1");
                assert.equal(jobs[2].name, "box2");
            });
            
            QUnit.test("addJobWithChildren", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                var jobArray = $.grep(testJil, function(job) { return job.name == "box1"; });
                builder.addJobWithChildren(jobArray[0], builder.topContainer);
                assert.equal($(builder.topContainer).children().length, 1);
                var boxDiv = $(builder.topContainer).children()[0];
                assert.equal($(boxDiv).children().length, 2);
            });

            QUnit.test("insertDivs", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                builder.insertDivs();
                assert.equal($(builder.topContainer).children().length, 3);
            });
            
            QUnit.test("findJob", function( assert ) {
                var builder = initBuilder(testJil, $("#graphContainer1")[0]);
                assert.equal(builder.findJob("box1"), testJil[1]);
            });
            
            QUnit.test("getDependencies and getConnections", function( assert ) {
                var jil = [
                    {
                        name: "job1",
                        job_type: "c",
                    },
                    {
                        name: "job2",
                        job_type: "c",
                        condition: "s(job1)",
                    },
                    {
                        name: "job3",
                        job_type: "c",
                        condition: "success(job1)",
                    },
                    {
                        name: "job4",
                        job_type: "c",
                        condition: "test: s(job1) and n(job2)|(success(box1)& s(box2)) or  failure  (job3)",
                    },
                    {
                        name: "box1",
                        job_type: "b",
                    },
                    {
                        name: "box2",
                        job_type: "b",
                    },
                ]
                var builder = initBuilder(jil, $("#graphContainer1")[0]);
                var job1 = builder.findJob("job1");
                var job2 = builder.findJob("job2");
                var job3 = builder.findJob("job3");
                var job4 = builder.findJob("job4");
                var box1 = builder.findJob("box1");
                var box2 = builder.findJob("box2");
                assert.deepEqual(builder.getDependencies(job1), []);
                assert.deepEqual(builder.getDependencies(job2), [new JilConnection(job2, job1, "s")]);
                assert.deepEqual(builder.getDependencies(job3), [new JilConnection(job3, job1, "s")]);
                assert.deepEqual(builder.getDependencies(job4), [
                    new JilConnection(job4, job1, "s"),
                    new JilConnection(job4, job2, "n"),
                    new JilConnection(job4, box1, "s"),
                    new JilConnection(job4, box2, "s"),
                    new JilConnection(job4, job3, "f"),
                ]);
                assert.deepEqual(builder.getConnections(), [
                    new JilConnection(job2, job1, "s"),
                    new JilConnection(job3, job1, "s"),
                    new JilConnection(job4, job1, "s"),
                    new JilConnection(job4, job2, "n"),
                    new JilConnection(job4, box1, "s"),
                    new JilConnection(job4, box2, "s"),
                    new JilConnection(job4, job3, "f"),
                ]);
            });
        });
    </script>

    <style type="text/css">
        code { white-space: pre; }
    </style>

</head>

<body>

    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    
    <code id="graphContainer1"></code>
    <hr/>
    <code id="testJil1">
/* 
* Job 1
*/

insert_job: box1
job_type: b

/* Job 1_2 */

insert_job: job1_2 /* Another comment */
job_type: c
command: start "/* 'some'thing */"
    </code>
    <hr/>
    <code id="removeCommentsResult">
insert_job: box1
job_type: b



insert_job: job1_2 
job_type: c
command: start ""
    </code>
    <hr/>
    <code id="quoteValuesResult">
{
"box1": {
"job_type": "b",
},
"job1_2": {
"job_type": "c",
"command": "start \"\"",
}}
    </code>
    <hr/>
    <code id="test1">
{
"box1": {
"job_type": "b",
},
"job1_2": {
"job_type": "c",
"command": "start \"\"",
}}
    </code>
	
</body>
</html> 
